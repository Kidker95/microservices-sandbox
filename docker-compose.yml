services:
  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    env_file:
      - ./services/auth-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/auth
      JWT_SECRET: ${JWT_SECRET}
      USER_SERVICE_BASE_URL: http://user-service:4001
    depends_on:
      - mongo

  user-service:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    env_file:
      - ./services/user-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/users
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
    depends_on:
      - mongo
      - auth-service


  product-service:
    build:
      context: .
      dockerfile: services/product-service/Dockerfile
    env_file:
      - ./services/product-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/products
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
    depends_on:
      - mongo
      - auth-service


  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    env_file:
      - ./services/order-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/orders
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
      USER_SERVICE_BASE_URL: http://user-service:4001/api
      PRODUCT_SERVICE_BASE_URL: http://product-service:4003/api
    depends_on:
      - mongo
      - auth-service
      - user-service
      - product-service


  receipt-service:
    build:
      context: .
      dockerfile: services/receipt-service/Dockerfile
    env_file:
      - ./services/receipt-service/.env
    environment:
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
      ORDER_SERVICE_BASE_URL: http://order-service:4002/api
      USER_SERVICE_BASE_URL: http://user-service:4001/api
      PRODUCT_SERVICE_BASE_URL: http://product-service:4003/api
      FORTUNE_SERVICE_BASE_URL: http://fortune-service:4006/api
    depends_on:
      - auth-service
      - order-service
      - user-service
      - product-service
      - fortune-service


  fortune-service:
    build:
      context: .
      dockerfile: services/fortune-service/Dockerfile
    env_file:
      - ./services/fortune-service/.env


  admin-service:
    build:
      context: .
      dockerfile: services/admin-service/Dockerfile
    env_file:
      - ./services/admin-service/.env
    environment:
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
      USER_SERVICE_BASE_URL: http://user-service:4001
      ORDER_SERVICE_BASE_URL: http://order-service:4002
      PRODUCT_SERVICE_BASE_URL: http://product-service:4003
      RECEIPT_SERVICE_BASE_URL: http://receipt-service:4004
      FORTUNE_SERVICE_BASE_URL: http://fortune-service:4006
      NGINX_HEALTH_URL: http://gateway:8080
      GATEWAY_BASE_URL: http://nginx:8080
    depends_on:
      - auth-service
      - user-service
      - order-service
      - product-service
      - receipt-service
      - fortune-service
 

  nginx:
    image: nginx:alpine
    container_name: gateway
    ports:
      - "8080:8080"
    volumes:
      - ./infra/nginx/nginx.docker.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - admin-service
      - auth-service
      - user-service
      - order-service
      - product-service
      - receipt-service
      - fortune-service

  seed:
    image: node:20-alpine
    profiles: ["tools"]
    working_dir: /repo
    volumes:
      - ./:/repo
    command: sh -c "npm ci && npm run seed -- --docker"
    depends_on:
      - auth-service
      - user-service
      - product-service
      - order-service

volumes:
  mongo_data:
