services:
  mongo:
    image: mongo:7
    container_name: mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    env_file:
      - ./services/auth-service/.env
    environment:
      # override localhost DB if your .env still uses localhost
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/auth
      # hard-standardize the secret name used by code
      JWT_SECRET: ${JWT_SECRET}
      USER_SERVICE_BASE_URL: http://user-service:4001
    depends_on:
      - mongo
    ports:
      - "4007:4007"

  user-service:
    build: ./services/user-service
    container_name: user-service
    env_file:
      - ./services/user-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/users
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
    depends_on:
      - mongo
      - auth-service
    ports:
      - "4001:4001"

  product-service:
    build: ./services/product-service
    container_name: product-service
    env_file:
      - ./services/product-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/products
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
    depends_on:
      - mongo
      - auth-service
    ports:
      - "4003:4003"

  order-service:
    build: ./services/order-service
    container_name: order-service
    env_file:
      - ./services/order-service/.env
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongo:27017/orders
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
      USER_SERVICE_BASE_URL: http://user-service:4001/api
      PRODUCT_SERVICE_BASE_URL: http://product-service:4003/api
    depends_on:
      - mongo
      - auth-service
      - user-service
      - product-service
    ports:
      - "4002:4002"

  receipt-service:
    build: ./services/receipt-service
    container_name: receipt-service
    env_file:
      - ./services/receipt-service/.env
    environment:
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
      ORDER_SERVICE_BASE_URL: http://order-service:4002/api
      USER_SERVICE_BASE_URL: http://user-service:4001/api
      PRODUCT_SERVICE_BASE_URL: http://product-service:4003/api
      FORTUNE_SERVICE_BASE_URL: http://fortune-service:4006/api
    depends_on:
      - auth-service
      - order-service
      - user-service
      - product-service
      - fortune-service
    ports:
      - "4004:4004"

  fortune-service:
    build: ./services/fortune-service
    container_name: fortune-service
    env_file:
      - ./services/fortune-service/.env
    ports:
      - "4006:4006"

  admin-service:
    build: ./services/admin-service
    container_name: admin-service
    env_file:
      - ./services/admin-service/.env
    environment:
      AUTH_SERVICE_BASE_URL: http://auth-service:4007
      USER_SERVICE_BASE_URL: http://user-service:4001
      ORDER_SERVICE_BASE_URL: http://order-service:4002
      PRODUCT_SERVICE_BASE_URL: http://product-service:4003
      RECEIPT_SERVICE_BASE_URL: http://receipt-service:4004
      FORTUNE_SERVICE_BASE_URL: http://fortune-service:4006
      # optional (if you use it in admin-service):
      NGINX_HEALTH_URL: http://gateway:8080
    depends_on:
      - auth-service
      - user-service
      - order-service
      - product-service
      - receipt-service
      - fortune-service
    ports:
      - "4005:4005"

  nginx:
    image: nginx:alpine
    container_name: gateway
    ports:
      - "8080:8080"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - admin-service
      - auth-service
      - user-service
      - order-service
      - product-service
      - receipt-service
      - fortune-service

volumes:
  mongo_data:
